package com.example.edrsystem;

import com.google.common.util.concurrent.RateLimiter;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.logging.Logger;

public class MalwareChecker {
    private static final Logger logger = Logger.getLogger(MalwareChecker.class.getName());
    private final VirusTotalClient virusTotalClient;
    private final MalwaresComClient malwaresComClient;
    private final RateLimiter rateLimiter;
    private final ExpiringCache<String, Boolean> hashCache;

    public MalwareChecker() {
        this.virusTotalClient = new VirusTotalClient();
        this.malwaresComClient = new MalwaresComClient();
        this.rateLimiter = RateLimiter.create(4.0 / 60.0); // 4 requests per minute
        this.hashCache = new ExpiringCache<>(3600000); // 1 hour expiration
    }

    public void checkFileForMalware(Path file, String fileHash) {
        rateLimiter.acquire();

        Boolean cachedResult = hashCache.get(fileHash);

        if (cachedResult != null) {
            if (cachedResult) {
                logger.severe(String.format("Cached result: Malware detected in file: %s", file));
                alertSecurityTeam(file, fileHash    );
            } else {
                logger.info(String.format("Cached result: File hash check passed for %s", file));
            }
            return;
        }
        //Since currently using only virus total
        boolean isMalicious = virusTotalClient.checkFileHash(fileHash);

        // for both virus total and malwareCom
        //boolean isMalicious = virusTotalClient.checkFileHash(fileHash)||malwaresComClient.checkFileHash(fileHash);

        if (isMalicious) {
            logger.severe(String.format("WARNING: Potential malware detected: %s", file));
            alertSecurityTeam(file, fileHash );
            //deleteMaliciousFile(file);
        } else {
            logger.info(String.format("File hash check passed: %s", file));
        }

        hashCache.put(fileHash, isMalicious);
    }

    private void alertSecurityTeam(Path file, String fileHash) {
        // TODO: Implement a real-time alerting system
        logger.severe(String.format("ALERT: Potential malware detected. File: %s, Hash: %s, Context: %s", file, fileHash));
    }

    private void deleteMaliciousFile(Path file) {
        try {
            Files.delete(file);
            logger.info(String.format("Malicious file deleted: %s", file));
        } catch (IOException e) {
            logger.severe(String.format("Failed to delete malicious file: %s. Error: %s", file, e.getMessage()));
            // TODO: Consider additional error handling or recovery steps
        }
    }
}